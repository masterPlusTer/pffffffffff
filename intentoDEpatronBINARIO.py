import time
from machine import Pin, freq

# Overclocking opcional para mejorar el rendimiento
freq(250_000_000)

# Configuración de pines de color
R1 = Pin(4, Pin.OUT)  # Rojo fila superior
G1 = Pin(2, Pin.OUT)  # Verde fila superior
B1 = Pin(3, Pin.OUT)  # Azul fila superior
R2 = Pin(9, Pin.OUT)  # Rojo fila inferior
G2 = Pin(5, Pin.OUT)  # Verde fila inferior
B2 = Pin(8, Pin.OUT)  # Azul fila inferior

# Configuración de pines de control
CLK = Pin(11, Pin.OUT)  # Reloj
LAT = Pin(12, Pin.OUT)  # Latch
OE = Pin(13, Pin.OUT)   # Output Enable

# Pines de selección de filas
A = Pin(10, Pin.OUT)
B = Pin(16, Pin.OUT)
C = Pin(18, Pin.OUT)
D = Pin(20, Pin.OUT)
E = Pin(22, Pin.OUT)

# Función para seleccionar una fila específica
def select_row_optimized(row):
    # Convertimos el número de fila a binario y ajustamos los pines
    binary_row = row & 0b11111  # Aseguramos solo 5 bits
    A.value(binary_row & 0b1)
    B.value((binary_row >> 1) & 0b1)
    C.value((binary_row >> 2) & 0b1)
    D.value((binary_row >> 3) & 0b1)
    E.value((binary_row >> 4) & 0b1)

# Función para enviar bits RGB
def send_color_data(r1, g1, b1, r2, g2, b2):
    # Configuramos los valores de color
    R1.value(r1)
    G1.value(g1)
    B1.value(b1)
    R2.value(r2)
    G2.value(g2)
    B2.value(b2)
    # Generamos un pulso de reloj
    CLK.value(1)
    CLK.value(0)

# Función para dibujar una fila completa
def draw_pattern_row(row_pattern_upper, row_pattern_lower):
    for col in range(64):  # Iteramos por las 64 columnas
        # Extraemos los bits de color para cada LED
        bit_upper = (row_pattern_upper >> (63 - col)) & 1
        bit_lower = (row_pattern_lower >> (63 - col)) & 1
        # Enviamos los bits a los pines
        send_color_data(bit_upper, 0, 0, bit_lower, 0, 0)

# Refrescar la pantalla completa con menor parpadeo
def refresh_display_minimized_flicker(pattern):
    while True:
        for row in range(32):  # 32 filas visibles
            OE.value(1)  # Desactivamos salida durante configuración
            select_row_optimized(row)  # Seleccionamos la fila actual
            draw_pattern_row(pattern[row], pattern[row + 32])  # Dibujamos fila
            LAT.value(1)  # Pulsamos latch para almacenar datos
            LAT.value(0)
            OE.value(0)  # Activamos salida para mostrar
            time.sleep_us(40)  # Reducir tiempo de espera para minimizar parpadeo

# Crear un patrón de prueba
pattern = [
    0b1111000000000000000000000000000000000000000000000000000000000000,  # Línea parcial
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000001111111111111000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,
    0b0000000000000000000000000000000000000000000000000000000000000000,
    0b0000000000000000000000000000000000000000000000000000000000000000,# Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000011000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000001110000000000000000000000000000111,  # Vacío
    0b1111000000000000000000000000001110000000000000000000000000000000,  # Línea parcial
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000110000000000000000000000000011000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000000000,  # Vacío
    0b0000000000000000000000000000000000000000000000000000000000001111, # Fondo negro
] 

# Ejecutar el refresco
refresh_display_minimized_flicker(pattern)
